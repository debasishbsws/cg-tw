# Autogenerated Pipeline Tests

This document provides comprehensive documentation for the autogenerated pipeline test infrastructure.

## Table of Contents

- [Overview](#overview)
- [Architecture](#architecture)
- [Test Case Format](#test-case-format)
- [Generated Config Structure](#generated-config-structure)
- [Directory Structure](#directory-structure)
- [Usage Examples](#usage-examples)
- [Test Execution Flow](#test-execution-flow)
- [Failure Reporting](#failure-reporting)
- [Creating New Tests](#creating-new-tests)
- [Advanced Features](#advanced-features)
- [Troubleshooting](#troubleshooting)
- [Implementation Details](#implementation-details)

## Overview

The autogenerated test infrastructure eliminates code duplication by generating Melange test configurations from declarative YAML test case definitions. Instead of writing full Melange YAML files for each test scenario, you define test cases in a simple format, and the system generates and runs the necessary configurations.

### Key Benefits

- **No code duplication**: Define multiple test cases concisely
- **Easy maintenance**: Update test logic in one place
- **Consistent structure**: All tests follow the same pattern
- **Real package testing**: Test pipelines with actual Wolfi packages
- **Positive and negative testing**: Verify both success and failure cases
- **Detailed failure reporting**: Get actionable information when tests fail
- **Independent execution**: Run individual test suites or all tests

### Comparison: Manual vs Autogenerated

**Manual Approach** (docs-test.yaml):
```yaml
# 120+ lines per test scenario
package:
  name: test-giflib-doc
  version: 0.0.0
  epoch: 0
  description: Test docs pipeline with giflib-doc
  copyright:
    - license: Apache-2.0

environment:
  contents:
    packages:
      - wolfi-base

test:
  environment:
    contents:
      packages:
        - giflib-doc
  pipeline:
    - uses: test/tw/docs
```

**Autogenerated Approach** (testcases/docs-pipeline.yaml):
```yaml
# Clear 1:1 mapping between test cases and packages
name: Docs pipeline validation tests

testcases:
  - name: Valid docs package giflib-doc
    package: giflib-doc
    pipelines:
      - uses: test/tw/docs
    expect_pass: true

  - name: Valid docs package curl-doc
    package: curl-doc
    pipelines:
      - uses: test/tw/docs
    expect_pass: true

  - name: Invalid docs package bash
    package: bash
    pipelines:
      - uses: test/tw/docs
    expect_pass: false
```

## Architecture

### Components

1. **Test Case Definitions** (`tests/testcases/*.yaml`)
   - Declarative YAML files defining test scenarios
   - One file per pipeline being tested
   - Contains both positive and negative test cases

2. **Test Runner** (`tests/pipeline-runner/`)
   - Go-based CLI application
   - Reads test case definitions
   - Generates Melange configurations
   - Executes tests via melange CLI
   - Reports results with detailed failure information

3. **Generated Configs** (`tests/generated/`)
   - Auto-generated Melange YAML files
   - Organized into `pass-*/` and `fail-*/` directories
   - Gitignored (regenerated on each run)
   - One file per package per test case

4. **Makefile Integration**
   - Convenient targets for running tests
   - Handles dependencies and build steps
   - Supports running specific test suites

### Architecture Diagram

```
testcases/
├── docs-pipeline.yaml          Test Case Definitions
├── staticpackage-pipeline.yaml
└── ...
          |
          v
    [Test Runner]               Go Application
          |
          ├─> generates ────> generated/
          |                    ├── pass-docs-pipeline/
          |                    │   ├── giflib-doc.yaml
          |                    │   └── curl-doc.yaml
          |                    └── fail-docs-pipeline/
          |                        └── bash.yaml
          |
          └─> executes ────> melange test
                                  |
                                  v
                            [Test Results]
```

## Test Case Format

### Basic Structure

```yaml
name: <suite-name>
description: <optional-description>

testcases:
  - name: <test-name>
    description: <optional-description>
    package: <package-name>
    pipelines:
      - uses: <pipeline-path>
        with:
          <param>: <value>
    expect_pass: <true|false>
    test-dependencies:
      - <dependency-1>
      - <dependency-2>
```

### Field Reference

#### Suite Level

- **name** (required): Name of the test suite (used for generated directory names)
- **description** (optional): Human-readable description of the suite's purpose

#### Test Case Level

- **name** (required): Descriptive name for the test case
- **description** (optional): Detailed explanation of what the test validates
- **package** (required): Single Wolfi package name to test (1:1 mapping)
- **pipelines** (required): List of pipeline configurations to apply
- **expect_pass** (required): Boolean indicating if test should pass (true) or fail (false)
- **test-dependencies** (optional): List of additional packages needed as test-time dependencies

#### Pipeline Configuration

- **uses** (required): Path to the pipeline (e.g., `test/tw/docs`)
- **with** (optional): Dictionary of parameters to pass to the pipeline

### Example: Complete Test Suite

```yaml
name: Virtual package validation tests
description: Test suite for test/tw/virtualpackage pipeline

testcases:
  - name: Check glibc provides so:libc.so.6
    description: Verify glibc correctly provides the libc shared object
    package: glibc
    pipelines:
      - uses: test/tw/virtualpackage
        with:
          virtual-pkg-name: so:libc.so.6
    expect_pass: true

  - name: Check glibc does not provide nonexistent virtual package
    description: Verify virtualpackage pipeline fails for missing virtual packages
    package: glibc
    pipelines:
      - uses: test/tw/virtualpackage
        with:
          virtual-pkg-name: nonexistent-virtual-pkg
    expect_pass: false

  - name: Check bash does not provide so:libc.so.6
    description: Verify bash does not provide so:libc.so.6 virtual package
    package: bash
    pipelines:
      - uses: test/tw/virtualpackage
        with:
          virtual-pkg-name: so:libc.so.6
    expect_pass: false
```

### Example: Test with Dependencies

```yaml
name: Pipeline tests requiring specific dependencies
description: Test suite demonstrating test-time dependencies

testcases:
  - name: Test package with specific build tools
    description: Verify pipeline works with additional dependencies
    package: my-package
    pipelines:
      - uses: test/tw/my-pipeline
    test-dependencies:
      - build-base
      - git
      - curl
    expect_pass: true
```

## Generated Config Structure

The test runner generates standard Melange YAML configurations:

```yaml
# Auto-generated melange test file
# DO NOT EDIT - Generated by pipeline-runner

package:
  name: giflib-doc
  version: 0.0.0
  epoch: 0
  description: Verify docs pipeline passes for valid giflib-doc documentation package

environment:
  contents:
    packages:
      - wolfi-base

test:
  environment:
    contents:
      packages:
        - wolfi-base
        # Additional packages from --append-packages flag
        # Additional packages from test-dependencies field
  pipeline:
    - uses: test/tw/docs
```

### Key Features of Generated Configs

- **Auto-generated header**: Clearly marked as generated
- **Package name**: Matches the package being tested (1:1 mapping)
- **Version**: Always 0.0.0 (not built, only tested)
- **Base environment**: Includes wolfi-base by default
- **Test dependencies**: Combines global append-packages with test-specific dependencies
- **Test pipeline**: Directly copied from test case definition
- **Pipeline parameters**: Passed through via `with` clause
- **No copyright field**: Not required for test configurations

## Directory Structure

### Input (Source Controlled)

```
tests/
├── testcases/                          # Test case definitions
│   ├── docs-pipeline.yaml              # Docs pipeline tests
│   ├── staticpackage-pipeline.yaml     # Static package tests
│   ├── contains-files-pipeline.yaml    # File existence tests
│   ├── metapackage-pipeline.yaml       # Meta package tests
│   ├── virtualpackage-pipeline.yaml    # Virtual package tests
│   └── emptypackage-pipeline.yaml      # Empty package tests
└── pipeline-runner/                    # Test runner source
    ├── main.go
    ├── go.mod
    └── go.sum
```

### Output (Generated, Gitignored)

```
tests/
└── generated/                                  # Auto-generated configs
    ├── pass-docs-pipeline-validation-tests/    # Positive tests
    │   ├── giflib-doc.yaml                     # Individual test configs
    │   └── curl-doc.yaml
    ├── fail-docs-pipeline-validation-tests/    # Negative tests
    │   ├── glibc.yaml
    │   └── bash.yaml
    ├── pass-staticpackage-pipeline/
    │   └── glib-static.yaml
    └── fail-staticpackage-pipeline/
        └── bash.yaml
```

### Directory Naming Convention

Generated directories follow this pattern:

- **Positive tests**: `pass-<sanitized-suite-name>/`
- **Negative tests**: `fail-<sanitized-suite-name>/`

Suite names are sanitized by:
- Converting to lowercase
- Replacing spaces with hyphens
- Removing special characters

Examples:
- "Docs pipeline validation tests" → `pass-docs-pipeline-validation-tests/`
- "Virtual Package Tests" → `pass-virtual-package-tests/`

## Usage Examples

### Logging Modes

All test commands support two logging modes:

**Normal Mode (Default) - Clean output with results:**
```bash
# Shows test progress and results, completely hides melange output
make test-pipelines-autogen

# Sample output:
# Found 6 test suite files
# Processing test suite: tests/testcases/docs-pipeline.yaml
# Test Suite: Docs pipeline validation tests
#   ✓ Generated positive test: tests/generated/pass-docs-pipeline/giflib-doc.yaml
#     ✓ PASS: Valid docs package giflib-doc (correctly accepted giflib-doc)
#   ✓ Generated positive test: tests/generated/pass-docs-pipeline/curl-doc.yaml
#     ✓ PASS: Valid docs package curl-doc (correctly accepted curl-doc)
#   ✓ Generated negative test: tests/generated/fail-docs-pipeline/bash.yaml
#     ✓ PASS: Invalid docs package bash (correctly rejected bash)
# ...
# ========================================
# Test Results:
#   Passed: 15
#   Failed: 0
#   Total:  15
# ========================================
```

**Key Features of Normal Mode:**
- Clean, focused output showing only test results
- **No melange output displayed at all** - not even on failures
- Perfect for CI/CD pipelines and daily development
- To see what went wrong in a failing test, re-run with `DEBUG=1`

**Debug Mode - Full melange output and internal details:**
```bash
# Shows [DEBUG] messages and real-time melange output
DEBUG=1 make test-pipelines-autogen

# Sample output:
# Processing test suite: tests/testcases/docs-pipeline.yaml
# [DEBUG] Loading test suite from: tests/testcases/docs-pipeline.yaml
# Test Suite: Docs pipeline validation tests
# [DEBUG] Test suite has 4 test cases
# [DEBUG] Processing 2 positive test cases
#   ✓ Generated positive test: tests/generated/pass-docs-pipeline/giflib-doc.yaml
# [DEBUG]     Package: giflib-doc, Expect pass: true
# [DEBUG] Running melange command: melange test --runner docker ...
# 2026/01/27 17:48:15 INFO melange 0.39.0 with runner docker is testing:
# 2026/01/27 17:48:15 INFO image configuration:
# 2026/01/27 17:48:15 INFO   contents:
# [... full melange output in real-time ...]
#     ✓ PASS: Valid docs package giflib-doc (correctly accepted giflib-doc)
# ...
```

**Key Features of Debug Mode:**
- Shows all normal mode output
- Displays [DEBUG] messages with internal details
- Shows complete melange command being executed
- Displays full melange output in real-time (stdout and stderr)
- Essential for troubleshooting failures and understanding what melange is doing

### Running All Tests

```bash
# Run all autogenerated tests (normal mode - clean output)
make test-pipelines-autogen

# Run with debug output (shows melange output)
DEBUG=1 make test-pipelines-autogen
```

### Running Specific Test Suite

```bash
# Run only the docs pipeline tests (normal mode)
make test-pipelines-autogen/docs-pipeline

# Run with debug output for troubleshooting
DEBUG=1 make test-pipelines-autogen/staticpackage-pipeline
```

### Generating Configs Without Running Tests

```bash
# Generate all configs but don't run tests (normal mode)
make generate-pipeline-tests

# Generate with debug output to see internal details
DEBUG=1 make generate-pipeline-tests

# Output (normal mode):
#   ✓ Generated positive test: tests/generated/pass-docs-pipeline/giflib-doc.yaml
#   ✓ Generated positive test: tests/generated/pass-docs-pipeline/curl-doc.yaml
#   ...
#   Generation Results:
#     Total configs generated: 15
#     Output directory: tests/generated
```

This is useful for:
- Inspecting generated configurations
- Debugging test definitions
- Understanding what will be tested

### Manual Test Execution

For debugging, you can run tests manually:

```bash
# First, generate the configs
make generate-pipeline-tests

# Then run melange test directly
melange test \
  --runner docker \
  --arch x86_64 \
  --pipeline-dirs ./pipelines \
  --repository-append ./packages \
  --keyring-append ./local-melange.rsa.pub \
  --test-package-append wolfi-base \
  --debug \
  tests/generated/pass-docs-pipeline/giflib-doc.yaml
```

## Test Execution Flow

### Detailed Flow

1. **Initialization**
   - Parse command-line flags
   - Validate required parameters
   - Determine test suite(s) to run

2. **Discovery**
   - Scan `tests/testcases/` for YAML files
   - Load and parse each test suite
   - Separate into positive and negative test cases

3. **Generation**
   - Create output directories (`pass-*/` and `fail-*/`)
   - For each test case and package:
     - Generate Melange YAML configuration
     - Write to appropriate directory
     - Log generation success

4. **Execution** (if not `--generate-only`)
   - For each generated config:
     - Invoke melange test via subprocess
     - Capture output and exit code
     - Compare result to expectation

5. **Result Collection**
   - Track passed/failed counts
   - Collect detailed failure information
   - Store config paths and error messages

6. **Reporting**
   - Display immediate results during execution
   - Show summary at end
   - For failures: display detailed information with re-run commands

### Success Criteria

A test passes when:

- **Positive test**: melange test exits with code 0
- **Negative test**: melange test exits with non-zero code

A test fails when:

- **Positive test**: melange test exits with non-zero code
- **Negative test**: melange test exits with code 0

## Failure Reporting

When tests fail, the system provides detailed information both during execution and in a summary at the end.

### Immediate Failure Output

```
    ✗ FAIL: Invalid docs package bash
      Package: bash
      Expected: fail
      Actual:   pass
      Config:   tests/generated/fail-docs-pipeline/bash.yaml
      Run:      make test-pipelines-autogen/docs-pipeline
      Error:    expected test to fail but it passed
```

### End-of-Test Summary

```
========================================
Test Results:
  Passed: 14
  Failed: 1
  Total:  15

Failing Test Details:
----------------------------------------

1. Invalid docs package bash
   Package:  bash
   Expected: fail
   Actual:   pass
   Config:   tests/generated/fail-docs-pipeline/bash.yaml
   Run:      make test-pipelines-autogen/docs-pipeline
   Error:    expected test to fail but it passed

To debug failures:
  1. Check the generated config file listed above
  2. Run the specific test suite with the make command shown
  3. Run melange test directly with --debug for more details
========================================
```

### Failure Information Fields

- **Test Name**: Descriptive name from test case definition
- **Package**: The package being tested
- **Expected**: "pass" or "fail" based on `expect_pass`
- **Actual**: What actually happened
- **Config**: Full path to generated config file
- **Run**: Make command to re-run just this test suite
- **Error**: Error message from melange (if applicable)

### Debugging Failed Tests

1. **Inspect the generated config**:
   ```bash
   cat tests/generated/fail-docs-pipeline/bash.yaml
   ```

2. **Run the specific test suite**:
   ```bash
   make test-pipelines-autogen/docs-pipeline
   ```

3. **Run melange with debug output**:
   ```bash
   melange test --debug \
     --runner docker \
     --arch x86_64 \
     --pipeline-dirs ./pipelines \
     tests/generated/fail-docs-pipeline/bash.yaml
   ```

4. **Check the pipeline implementation**:
   ```bash
   cat pipelines/test/tw/docs.yaml
   ```

## Creating New Tests

### Step-by-Step Guide

#### 1. Create Test Suite File

Create a new YAML file in `tests/testcases/`:

```bash
vim tests/testcases/my-pipeline.yaml
```

#### 2. Define Test Cases

```yaml
name: My pipeline validation tests
description: Test suite for test/tw/my-pipeline

testcases:
  # Positive test: should pass
  - name: Valid case - package-1 meets criteria
    description: Verify pipeline accepts valid package-1
    package: valid-package-1
    pipelines:
      - uses: test/tw/my-pipeline
    expect_pass: true

  - name: Valid case - package-2 meets criteria
    description: Verify pipeline accepts valid package-2
    package: valid-package-2
    pipelines:
      - uses: test/tw/my-pipeline
    expect_pass: true

  # Negative test: should fail
  - name: Invalid case - package missing requirement
    description: Verify pipeline rejects invalid packages
    package: invalid-package
    pipelines:
      - uses: test/tw/my-pipeline
    expect_pass: false

  # Test with parameters
  - name: Valid case with parameters
    description: Test pipeline with custom parameters
    package: test-package
    pipelines:
      - uses: test/tw/my-pipeline
        with:
          param1: value1
          param2: value2
    expect_pass: true

  # Test with dependencies
  - name: Test requiring specific dependencies
    description: Test with additional test-time dependencies
    package: test-package
    pipelines:
      - uses: test/tw/my-pipeline
    test-dependencies:
      - build-base
      - git
    expect_pass: true
```

#### 4. Run Tests

```bash
# Run your specific test suite
make test-pipelines-autogen/my-pipeline

# Or run all tests
make test-pipelines-autogen
```

### Best Practices

#### Choose Real Packages

Use actual packages from Wolfi that exercise your pipeline:

```bash
# Search Wolfi packages
curl -s https://packages.wolfi.dev/os/x86_64/APKINDEX.tar.gz | \
  tar -xzO APKINDEX | \
  grep -A 5 "P:package-name"
```

#### Use Descriptive Names

Make test failures easy to understand:

```yaml
# Good: Clear what is being tested (includes package name)
- name: Valid static library - glib-static
  description: Verify staticpackage pipeline accepts packages with .a files
  package: glib-static

# Bad: Unclear purpose
- name: Test 1
  description: Test package
  package: some-package
```

#### One Package Per Test (1:1 Mapping)

Each test case tests exactly one package:

```yaml
testcases:
  # Good: One package per test
  - name: Valid documentation package curl-doc
    package: curl-doc
    pipelines:
      - uses: test/tw/docs
    expect_pass: true

  - name: Valid documentation package giflib-doc
    package: giflib-doc
    pipelines:
      - uses: test/tw/docs
    expect_pass: true

  # This provides:
  # - Clear test names
  # - Individual test execution
  # - Easier debugging
  # - Independent failures
```

#### Organize by Functionality

Group related tests in the same suite:

```yaml
name: Staticpackage pipeline tests

testcases:
  # Standard .a files
  - name: Standard static library with .a files - glib-static
    package: glib-static
    pipelines:
      - uses: test/tw/staticpackage
    expect_pass: true

  # No static libraries
  - name: Package without static libraries - bash
    package: bash
    pipelines:
      - uses: test/tw/staticpackage
    expect_pass: false

  # Edge case: .a files in wrong location
  - name: Static files in non-standard location - special-static
    package: special-static-package
    pipelines:
      - uses: test/tw/staticpackage
    expect_pass: false
```

#### Use Test Dependencies When Needed

Add test-time dependencies for tests that need specific tools:

```yaml
testcases:
  - name: Test requiring build tools
    package: my-package
    pipelines:
      - uses: test/tw/my-pipeline
    test-dependencies:
      - build-base
      - git
      - curl
    expect_pass: true
```

Global dependencies can be configured via `--append-packages` flag in Makefile.

## Advanced Features

### Test Suite Filtering

Run only specific test suites:

```bash
# Run single suite
make test-pipelines-autogen/docs-pipeline

# The test suite name comes from the filename:
# tests/testcases/docs-pipeline.yaml → docs-pipeline
# tests/testcases/virtualpackage-pipeline.yaml → virtualpackage-pipeline
```

### Test Dependencies

Configure test-time dependencies at the test case level or globally:

```yaml
testcases:
  # Test-specific dependencies
  - name: Test requiring specific tools
    package: my-package
    pipelines:
      - uses: test/tw/my-pipeline
    test-dependencies:
      - build-base
      - git
      - curl
    expect_pass: true

  # Dependencies are added to test.environment.contents.packages
  # Combined with global --append-packages flag
```

Global dependencies via Makefile:
```makefile
test-pipelines-autogen:
    $(TEST_RUNNER_BIN) \
        --append-packages "wolfi-base"
```

### Pipeline Parameters

Pass parameters to pipelines via the `with` clause:

```yaml
testcases:
  - name: Check for specific virtual package
    package: glibc
    pipelines:
      - uses: test/tw/virtualpackage
        with:
          virtual-pkg-name: so:libc.so.6
    expect_pass: true

  - name: Check for specific file
    package: bash
    pipelines:
      - uses: test/tw/contains-files
        with:
          files: |
            /usr/bin/bash
            /usr/share/bash
    expect_pass: true
```

### Multiple Pipelines

Test multiple pipelines in sequence:

```yaml
testcases:
  - name: Package must be both static and contain specific files
    package: glib-static
    pipelines:
      - uses: test/tw/staticpackage
      - uses: test/tw/contains-files
        with:
          files: /usr/lib/libglib-2.0.a
    expect_pass: true
```
